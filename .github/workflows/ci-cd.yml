name: CI-CD

on:
  push:
    branches: ["main"]

jobs:
  static-code-analysis:
    name: Static Code Analysis (Lint)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      # Reporta vulnerabilidades de dependencias (no bloquea deploy)
      - name: Dependency audit (report only)
        run: npm audit --audit-level=high || true

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci

      - name: Run tests
        run: npm test -- --runInBand

  code-coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci

      - name: Run coverage
        run: npm run test:coverage -- --runInBand

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage/

  # Escaneo de vulnerabilidades en repositorio (FS) -> SARIF (sin bloquear deploy)
  vulnerability-scan:
    name: Vulnerability Scan (Trivy - FS)
    runs-on: ubuntu-latest
    needs:
      - static-code-analysis
      - unit-tests
      - code-coverage

    permissions:
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - name: Trivy scan (repo filesystem) -> SARIF
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          ignore-unfixed: true
          format: sarif
          output: trivy-fs.sarif
          severity: CRITICAL,HIGH

      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-fs.sarif

  # Build de la imagen en un job separado para poder escanearla antes del push
  docker-build:
    name: Docker Build (Artifact for Scan)
    runs-on: ubuntu-latest
    needs:
      - static-code-analysis
      - unit-tests
      - code-coverage

    env:
      PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
      REGION: ${{ vars.GCP_REGION }}
      AR_REPO: ${{ vars.AR_REPO }}
      IMAGE_NAME: devsu-api
      TAG: ${{ github.sha }}

    steps:
      - uses: actions/checkout@v4

      - name: Set IMAGE_URI
        run: |
          echo "IMAGE_URI=${REGION}-docker.pkg.dev/${PROJECT_ID}/${AR_REPO}/${IMAGE_NAME}:${TAG}" >> $GITHUB_ENV

      - name: Build image
        run: docker build -t "${IMAGE_URI}" .

      - name: Save image as artifact
        run: docker save "${IMAGE_URI}" -o image.tar

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: image.tar

  # Escaneo de vulnerabilidades de la imagen (SARIF) (no bloquea deploy)
  docker-image-scan:
    name: Vulnerability Scan (Trivy - Docker Image)
    runs-on: ubuntu-latest
    needs:
      - docker-build

    permissions:
      contents: read
      security-events: write

    env:
      PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
      REGION: ${{ vars.GCP_REGION }}
      AR_REPO: ${{ vars.AR_REPO }}
      IMAGE_NAME: devsu-api
      TAG: ${{ github.sha }}

    steps:
      - uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load image into Docker
        run: docker load -i image.tar

      - name: Set IMAGE_URI
        run: |
          echo "IMAGE_URI=${REGION}-docker.pkg.dev/${PROJECT_ID}/${AR_REPO}/${IMAGE_NAME}:${TAG}" >> $GITHUB_ENV

      - name: Trivy scan (image) -> SARIF
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: ${{ env.IMAGE_URI }}
          ignore-unfixed: true
          format: sarif
          output: trivy-image.sarif
          severity: CRITICAL,HIGH

      - name: Upload SARIF (image) to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-image.sarif

  docker-push-deploy:
    name: Docker Push + Deploy to GKE
    runs-on: ubuntu-latest
    needs:
      - static-code-analysis
      - unit-tests
      - code-coverage
      - docker-build
      # Nota: no depende de los scans para que siempre despliegue..
      # - vulnerability-scan
      # - docker-image-scan

    permissions:
      contents: read
      id-token: write

    env:
      PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
      REGION: ${{ vars.GCP_REGION }}
      AR_REPO: ${{ vars.AR_REPO }}
      CLUSTER: ${{ vars.GKE_CLUSTER }}
      NAMESPACE: devsu
      IMAGE_NAME: devsu-api
      TAG: ${{ github.sha }}

    steps:
      - uses: actions/checkout@v4

      - name: Auth to GCP (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker "${REGION}-docker.pkg.dev" --quiet

      - name: Set IMAGE_URI
        run: |
          echo "IMAGE_URI=${REGION}-docker.pkg.dev/${PROJECT_ID}/${AR_REPO}/${IMAGE_NAME}:${TAG}" >> $GITHUB_ENV

      # Reusa el build del job docker-build para que sea consistente con el scan
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load image into Docker
        run: docker load -i image.tar

      - name: Push image
        run: docker push "${IMAGE_URI}"

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.CLUSTER }}
          location: ${{ env.REGION }}

      - name: Apply base manifests
        run: |
          kubectl apply -f k8s/00-namespace.yaml
          kubectl apply -f k8s/01-configmap.yaml

      - name: Upsert Kubernetes Secret from GitHub Secrets
        run: |
          kubectl -n ${NAMESPACE} create secret generic devsu-api-secrets \
            --from-literal=SECRETO_A='${{ secrets.SECRETO_A }}' \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy to GKE (apply deployment/service/hpa/ingress)
        run: |
          sed -e "s|IMAGE_PLACEHOLDER|${IMAGE_URI}|g" k8s/03-deployment.yaml | kubectl apply -f -
          kubectl apply -f k8s/04-service.yaml
          kubectl apply -f k8s/05-hpa.yaml
          kubectl apply -f k8s/06-ingress.yaml

      - name: Wait for rollout
        run: |
          kubectl -n ${NAMESPACE} rollout status deployment/devsu-api --timeout=180s
